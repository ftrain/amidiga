[env:teensy41]
platform = teensy
board = teensy41
framework = arduino
; C++ standard
build_flags =
    -std=c++17
    -DUSB_MIDI
    -DUSB_MIDI_SERIAL
    -Wall
    -Wextra
    -fno-exceptions
    -fno-rtti
    -DNO_EXCEPTIONS
    -DLUA_32BITS=1

; Library dependencies
lib_deps =
    https://github.com/lua/lua.git#v5.4.6
    ; Lua will be compiled from source (see lib/ directory)

; Pre-build script to patch Lua for Teensy compatibility
extra_scripts = pre:patch_lua.py

; Exclude problematic Lua source files (amalgamation and standalone tools)
lib_ignore =
    # Empty - we don't ignore entire libraries

; Advanced library configuration
lib_ldf_mode = deep+
lib_compat_mode = strict

; Source directories - include all src files but filter out desktop-specific
src_dir = src
lib_dir = lib

; Filter to exclude desktop-specific files from build
src_filter =
    +<*>
    -<desktop/>

; Build options
build_unflags =
monitor_speed = 115200

; Optimization
build_type = release

; Upload options
upload_protocol = teensy-gui
upload_port = /dev/ttyACM0

; Debug options (optional)
debug_tool = jlink
debug_init_break = tbreak setup
